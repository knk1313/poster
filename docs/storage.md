# 投稿済み記事 URL の保存仕様

## 目的

このドキュメントでは、ニュース投稿システムで使用する  
「投稿済み記事 URL の保存先」と「保存フォーマット」について定義する。

主な目的は以下のとおり：

- 同じ記事 URL を X に **重複投稿しない** ための履歴管理
- 「いつ・どのニュースを投稿したか」を **人間が一覧できる**

---

## 保存先

- Google スプレッドシート
- シート名: `posted_articles`
- シートは 1 システム = 1 シートを想定  
  （複数メディアに対応する場合は `source` カラムで判別する）

---

## カラム定義

| カラム位置 | カラム名  | 型     | 必須 | 説明                                                                                    |
| ---------- | --------- | ------ | ---- | --------------------------------------------------------------------------------------- |
| A          | posted_at | string | Yes  | 投稿実行日時。ISO8601 文字列（例: `2025-12-02T10:30:00+09:00`）または日付形式。         |
| B          | source    | string | Yes  | 記事の取得元。例: `yahoo_top`, `yahoo_ranking` など。                                   |
| C          | url       | string | Yes  | ニュース記事の URL。システム上は **実質ユニークキー** として扱う。                      |
| D          | title     | string | Yes  | 記事タイトル。スクレイピング or RSS から取得。                                          |
| E          | tweet_id  | string | No   | X 投稿のツイートID。投稿成功時のみ保存し、失敗時は空欄。                                |
| F          | summary   | string | Yes  | X 投稿に使用した本文（要約 or キャプション）。                                          |
| G          | condition | string | Yes  | 承認状態。`承認済み` / `保留中` / `不承認` のいずれか。MVP では `承認済み` 固定で保存。 |

### condition の意味

- `承認済み`
  - 投稿してよい（またはすでに投稿済み）ニュース。
  - MVP では、**自動投稿オンリー**のため常にこの状態で保存。
- `保留中`
  - 将来的に「人間の目による確認待ち」などに使う想定。
  - MVP では使用しないが、列は先行して定義。
- `不承認`
  - 投稿対象から除外するニュース。
  - 例：不適切な内容、重複だけどログとして残したいもの、など。

---

## 運用ルール

### 1. 重複チェック

新しいニュースを投稿する際、次のように重複チェックを行う：

1. 記事 URL を取得する（例: `https://news.yahoo.co.jp/...`）。
2. `posted_articles` シートの **C列 (url)** をスキャン。
3. 同じ URL が既に存在する場合は **スキップ** する。
   - 特に `condition` が `承認済み` の行があれば「投稿済み」とみなす。
4. 存在しない場合のみ、新規投稿処理を実行し、投稿後に 1 行追加する。

### 2. 1行追加時のデータ例

X への自動投稿が成功したとき、1 行は次のように書き込まれる。

- posted_at: `2025-12-02T10:30:00+09:00`
- source: `yahoo_ranking`
- url: `https://news.yahoo.co.jp/pickup/1234567`
- title: `〇〇に関する最新ニュース`
- tweet_id: `1861234567890123456`
- summary: `〇〇について、～～な点が話題となっています。詳細はこちら →`
- condition: `承認済み`

投稿失敗時の挙動は次のいずれかを選択する：

- **パターンA（MVP案）**
  - 投稿に失敗した場合は **シートに書き込まない**。
  - 次回の実行時に再度同じ URL が来れば、再投稿が試みられる。

- **パターンB（拡張案）**
  - 投稿に失敗した場合でも行を追加し、`tweet_id` を空欄にする。
  - 別途 `error_message` カラムなどを追加し、原因を残す。

MVP では簡潔さ重視で **パターンA** を採用することを想定。

---

## source の値のルール

`source` カラムには、**取得ロジックごとに固定の値**を入れることで、あとから分析しやすくする。

例：

- Yahoo!トップページの主要ニュース → `yahoo_top`
- Yahoo!ニュースのアクセスランキング → `yahoo_ranking`
- （将来追加）特定カテゴリ（例: 経済カテゴリ） → `yahoo_economy`

命名ルール：

- 英小文字 + アンダースコア
- 取得元（サイト名） + 取得方法（トップ/ランキング/カテゴリ など）

---

## condition の将来拡張

MVP では condition は常に `承認済み` だが、  
将来的に次のようなワークフローを想定できる：

1. クローラが「候補ニュース」を取得
2. `condition = 保留中` でシートに保存
3. 担当者が Google スプレッドシート上で人力チェック
4. 投稿OKなものを `承認済み` に変更
5. バッチ（bot）が `condition = 承認済み` の行だけを抽出して X に投稿

この拡張を想定し、MVP 段階から `condition` をカラムとして確保している。
